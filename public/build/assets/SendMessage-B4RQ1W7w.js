import{d as K,r as m,k as w,m as Q,n as B,p as Y,o as n,b as e,x as d,y as u,s as S,f as _,B as A,c as a,C as Z,F as ee,q as te,t as l,g as v,i as b,v as P}from"./main-xs8j4uZ-.js";import{_ as se,r as z,c as R,d as oe,e as le,f as re}from"./api-B8rOhXTt.js";import{c as ne}from"./contactService-NNlOP3aH.js";import{s as ie,a as ae,b as ue}from"./notifications-CHQAjgV4.js";import{r as de}from"./UserIcon-BaWFqzAi.js";import{r as j}from"./PhoneIcon-ZJQWqxKv.js";import{r as I}from"./CheckCircleIcon-De1Hy6On.js";import{r as L}from"./ExclamationCircleIcon-DMwTlQUq.js";import{r as ce}from"./ExclamationTriangleIcon-CHu3Kfhx.js";import{r as ve}from"./XCircleIcon-BEFS7arE.js";const me={class:"p-8"},pe={class:"mb-8"},fe={class:"flex items-center gap-2"},ge={class:"max-w-3xl mx-auto"},be={class:"rounded-lg border bg-card shadow-sm p-8 space-y-6"},xe={class:"space-y-3"},he={class:"grid grid-cols-1 md:grid-cols-3 gap-3"},ye={class:"flex-1"},we={class:"flex items-center gap-2"},_e={class:"flex-1"},ke={class:"flex items-center gap-2"},Se={class:"flex-1"},Me={class:"flex items-center gap-2"},$e={key:0,class:"space-y-2"},Ce=["value"],Xe={key:1,class:"space-y-2"},Ve={class:"text-sm font-medium flex items-center gap-2"},Ee={key:0,class:"space-y-1"},Ne={key:0,class:"flex items-center gap-1.5 text-xs text-success"},Ae={key:1,class:"flex items-center gap-1.5 text-xs text-destructive"},Pe={key:2,class:"space-y-2"},Fe={class:"text-sm font-medium flex items-center gap-2"},Ue={class:"grid grid-cols-2 md:grid-cols-4 gap-2 text-xs"},De={class:"flex items-center gap-1.5"},Te={key:0,class:"flex items-center gap-1.5"},Be={key:1,class:"flex items-center gap-1.5"},ze={key:2,class:"flex items-center gap-1.5"},Re={class:"space-y-2"},je={class:"flex items-center justify-between"},Ie={class:"text-sm font-medium flex items-center gap-2"},Le={class:"flex items-center gap-3 text-xs"},Ge={class:"text-muted-foreground"},qe={key:0,class:"px-2 py-1 bg-warning/10 text-warning rounded font-medium"},Oe={key:0,class:"flex items-center gap-1.5 text-xs text-warning"},We={class:"p-5 bg-gradient-to-r from-primary/10 to-primary/5 border-2 border-primary/20 rounded-lg"},He={class:"flex items-start gap-4"},Je={class:"flex-1"},Ke={class:"grid grid-cols-2 md:grid-cols-3 gap-4 text-sm"},Qe={class:"text-2xl font-bold text-foreground"},Ye={class:"text-2xl font-bold text-foreground"},Ze={class:"md:col-span-3"},et={class:"text-3xl font-bold text-primary"},tt={key:3,class:"rounded-lg bg-success/10 border border-success/20 p-4"},st={class:"flex items-center gap-2 text-success"},ot={class:"font-medium"},lt={key:4,class:"rounded-lg bg-destructive/10 border border-destructive/20 p-4"},rt={class:"flex items-center gap-2 text-destructive"},nt={class:"font-medium"},it={class:"flex gap-3 pt-4 border-t"},at=["disabled"],ut={key:1,class:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"},dt=["disabled"],_t=K({__name:"SendMessage",setup(ct){const o=m("contact"),x=m(""),p=m(""),h=m(""),y=m(""),E=m([]),k=m(!1),M=m(""),$=m(""),i=m({phone:null,multiple:{airtel:0,moov:0,invalid:0}});function F(c){let s=c.replace(/\D/g,"");if(s.startsWith("241")&&(s=s.substring(3)),s.length!==8)return{valid:!1,message:"Le numéro doit contenir 8 chiffres",operator:"unknown"};const r=s.substring(0,2),V=["77","74","76"],g=["60","62","65","66"];return V.includes(r)?{valid:!0,operator:"airtel",operator_name:"Airtel Gabon",prefix:r,formatted:`+241 ${s.substring(0,2)} ${s.substring(2,4)} ${s.substring(4,6)} ${s.substring(6,8)}`}:g.includes(r)?{valid:!0,operator:"moov",operator_name:"Moov Gabon",prefix:r,formatted:`+241 ${s.substring(0,2)} ${s.substring(2,4)} ${s.substring(4,6)} ${s.substring(6,8)}`}:{valid:!1,message:`Préfixe ${r} non reconnu (Airtel: 77, 74, 76 | Moov: 60, 62, 65, 66)`,operator:"unknown"}}function G(){if(!p.value.trim()){i.value.phone=null;return}i.value.phone=F(p.value)}function q(){const c=h.value.split(`
`).filter(s=>s.trim()),t={airtel:0,moov:0,invalid:0};c.forEach(s=>{const r=F(s);r.operator==="airtel"?t.airtel++:r.operator==="moov"?t.moov++:t.invalid++}),i.value.multiple=t}const O=w(()=>y.value.length),f=w(()=>Math.ceil(y.value.length/160)||1),N=w(()=>o.value==="multiple"&&h.value?h.value.split(`
`).filter(c=>c.trim()).length:0),C=w(()=>o.value==="contact"&&x.value||o.value==="phone"&&p.value?1:o.value==="multiple"?N.value:0),X=w(()=>C.value*f.value),U=w(()=>Math.round(X.value*20)),D=w(()=>!(!y.value.trim()||o.value==="contact"&&!x.value||o.value==="phone"&&!p.value.trim()||o.value==="multiple"&&N.value===0));async function W(){try{const c=await ne.getAll();E.value=c.filter(t=>t.status==="active")}catch(c){console.error("Error loading contacts:",c)}}async function H(){var t,s;if(!(!D.value||!await ie("Confirmer l'envoi",`Envoyer ${X.value} SMS (${C.value} destinataire(s) × ${f.value} SMS) pour ${U.value} XAF ?`))){k.value=!0,M.value="",$.value="";try{let r=[];if(o.value==="contact"&&x.value){const g=E.value.find(J=>J.id==x.value);console.log("Selected contact:",g,"Selected ID:",x.value),g&&(r=[g.phone])}else o.value==="phone"&&p.value?r=[p.value.trim()]:o.value==="multiple"&&h.value&&(r=h.value.split(`
`).map(g=>g.trim()).filter(g=>g));if(console.log("Recipients to send:",r),r.length===0)throw new Error("Aucun destinataire valide trouvé");const V={recipients:r,message:y.value,type:"immediate"};console.log("Sending data:",V),await re.post("/messages/send",V),ae(`${X.value} SMS envoyé(s) avec succès à ${C.value} destinataire(s) !`),setTimeout(()=>{T()},2e3)}catch(r){console.error("Error sending message:",r),ue(((s=(t=r.response)==null?void 0:t.data)==null?void 0:s.message)||"Erreur lors de l'envoi du message")}finally{k.value=!1}}}function T(){o.value="contact",x.value="",p.value="",h.value="",y.value="",M.value="",$.value=""}return Q(()=>{W()}),(c,t)=>(n(),B(se,null,{default:Y(()=>[e("div",me,[e("div",pe,[e("div",fe,[d(u(z),{class:"w-8 h-8 text-primary"}),t[7]||(t[7]=e("h1",{class:"text-3xl font-bold"},"Envoyer un message",-1))]),t[8]||(t[8]=e("p",{class:"text-muted-foreground mt-2"},"Envoyez un SMS rapide à un ou plusieurs destinataires",-1))]),e("div",ge,[e("div",be,[e("div",xe,[t[15]||(t[15]=e("label",{class:"text-sm font-medium"},"Type de destinataire",-1)),e("div",he,[e("label",{class:S(["flex items-start gap-3 p-4 border-2 rounded-lg cursor-pointer hover:bg-accent/50 transition-colors",o.value==="contact"?"border-primary bg-primary/5":"border-border"])},[_(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>o.value=s),type:"radio",value:"contact",class:"mt-1 w-4 h-4"},null,512),[[A,o.value]]),e("div",ye,[e("div",we,[d(u(de),{class:"w-5 h-5 text-primary"}),t[9]||(t[9]=e("div",{class:"font-semibold text-sm"},"Contact",-1))]),t[10]||(t[10]=e("div",{class:"text-xs text-muted-foreground mt-1"},"Depuis vos contacts",-1))])],2),e("label",{class:S(["flex items-start gap-3 p-4 border-2 rounded-lg cursor-pointer hover:bg-accent/50 transition-colors",o.value==="phone"?"border-primary bg-primary/5":"border-border"])},[_(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>o.value=s),type:"radio",value:"phone",class:"mt-1 w-4 h-4"},null,512),[[A,o.value]]),e("div",_e,[e("div",ke,[d(u(j),{class:"w-5 h-5 text-primary"}),t[11]||(t[11]=e("div",{class:"font-semibold text-sm"},"Numéro",-1))]),t[12]||(t[12]=e("div",{class:"text-xs text-muted-foreground mt-1"},"Saisir manuellement",-1))])],2),e("label",{class:S(["flex items-start gap-3 p-4 border-2 rounded-lg cursor-pointer hover:bg-accent/50 transition-colors",o.value==="multiple"?"border-primary bg-primary/5":"border-border"])},[_(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>o.value=s),type:"radio",value:"multiple",class:"mt-1 w-4 h-4"},null,512),[[A,o.value]]),e("div",Se,[e("div",Me,[d(u(R),{class:"w-5 h-5 text-primary"}),t[13]||(t[13]=e("div",{class:"font-semibold text-sm"},"Plusieurs",-1))]),t[14]||(t[14]=e("div",{class:"text-xs text-muted-foreground mt-1"},"Multiples numéros",-1))])],2)])]),o.value==="contact"?(n(),a("div",$e,[t[17]||(t[17]=e("label",{class:"text-sm font-medium"},"Sélectionner un contact *",-1)),_(e("select",{"onUpdate:modelValue":t[3]||(t[3]=s=>x.value=s),class:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"},[t[16]||(t[16]=e("option",{value:""},"Choisir un contact...",-1)),(n(!0),a(ee,null,te(E.value,s=>(n(),a("option",{key:s.id,value:s.id},l(s.name)+" ("+l(s.phone)+") ",9,Ce))),128))],512),[[Z,x.value]])])):v("",!0),o.value==="phone"?(n(),a("div",Xe,[e("label",Ve,[d(u(j),{class:"w-4 h-4 text-muted-foreground"}),t[18]||(t[18]=b(" Numéro de téléphone * ",-1))]),_(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>p.value=s),type:"tel",placeholder:"+241 77 75 07 37 ou 77750737",onInput:G,class:S(["flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",i.value.phone&&!i.value.phone.valid?"border-destructive":""])},null,34),[[P,p.value]]),i.value.phone?(n(),a("div",Ee,[i.value.phone.valid?(n(),a("p",Ne,[d(u(I),{class:"w-4 h-4"}),e("span",null,l(i.value.phone.operator_name)+" ("+l(i.value.phone.prefix)+") - Format: "+l(i.value.phone.formatted),1)])):(n(),a("p",Ae,[d(u(L),{class:"w-4 h-4"}),e("span",null,l(i.value.phone.message),1)]))])):v("",!0),t[19]||(t[19]=e("p",{class:"text-xs text-muted-foreground"},[b(" Format: +241 XX XX XX XX ou XX XX XX XX"),e("br"),b(" Airtel: 77, 74, 76 | Moov: 60, 62, 65, 66 ")],-1))])):v("",!0),o.value==="multiple"?(n(),a("div",Pe,[e("label",Fe,[d(u(R),{class:"w-4 h-4 text-muted-foreground"}),t[20]||(t[20]=b(" Numéros de téléphone (un par ligne) * ",-1))]),_(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=s=>h.value=s),onInput:q,placeholder:`+241 77 75 07 37
77 75 07 37
62 34 56 78`,rows:"5",class:"flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 resize-none font-mono"},null,544),[[P,h.value]]),e("div",Ue,[e("div",De,[t[22]||(t[22]=e("div",{class:"w-2 h-2 rounded-full bg-primary"},null,-1)),e("span",null,[e("strong",null,l(N.value),1),t[21]||(t[21]=b(" total",-1))])]),i.value.multiple.airtel>0?(n(),a("div",Te,[t[24]||(t[24]=e("div",{class:"w-2 h-2 rounded-full bg-red-500"},null,-1)),e("span",null,[e("strong",null,l(i.value.multiple.airtel),1),t[23]||(t[23]=b(" Airtel",-1))])])):v("",!0),i.value.multiple.moov>0?(n(),a("div",Be,[t[26]||(t[26]=e("div",{class:"w-2 h-2 rounded-full bg-blue-500"},null,-1)),e("span",null,[e("strong",null,l(i.value.multiple.moov),1),t[25]||(t[25]=b(" Moov",-1))])])):v("",!0),i.value.multiple.invalid>0?(n(),a("div",ze,[t[28]||(t[28]=e("div",{class:"w-2 h-2 rounded-full bg-destructive"},null,-1)),e("span",null,[e("strong",null,l(i.value.multiple.invalid),1),t[27]||(t[27]=b(" invalide(s)",-1))])])):v("",!0)]),t[29]||(t[29]=e("p",{class:"text-xs text-muted-foreground"}," Airtel: 77, 74, 76 | Moov: 60, 62, 65, 66 ",-1))])):v("",!0),e("div",Re,[e("div",je,[e("label",Ie,[d(u(oe),{class:"w-4 h-4 text-muted-foreground"}),t[30]||(t[30]=b(" Message * ",-1))]),e("div",Le,[e("span",Ge,l(O.value)+"/160 caractères",1),f.value>1?(n(),a("span",qe,l(f.value)+" SMS ",1)):v("",!0)])]),_(e("textarea",{"onUpdate:modelValue":t[6]||(t[6]=s=>y.value=s),placeholder:"Votre message SMS...",rows:"6",maxlength:"320",class:"flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 resize-none font-mono"},null,512),[[P,y.value]]),f.value>1?(n(),a("p",Oe,[d(u(ce),{class:"w-4 h-4"}),e("span",null,"Votre message sera envoyé en "+l(f.value)+" SMS (coût multiplié par "+l(f.value)+")",1)])):v("",!0)]),e("div",We,[e("div",He,[d(u(le),{class:"w-10 h-10 text-primary flex-shrink-0 mt-1"}),e("div",Je,[t[35]||(t[35]=e("p",{class:"font-bold text-lg mb-2"},"Estimation de l'envoi",-1)),e("div",Ke,[e("div",null,[t[31]||(t[31]=e("p",{class:"text-muted-foreground"},"Destinataires",-1)),e("p",Qe,l(C.value),1)]),e("div",null,[t[32]||(t[32]=e("p",{class:"text-muted-foreground"},"SMS par message",-1)),e("p",{class:S(["text-2xl font-bold",f.value>1?"text-warning":"text-foreground"])},l(f.value),3)]),e("div",null,[t[33]||(t[33]=e("p",{class:"text-muted-foreground"},"Total SMS",-1)),e("p",Ye,l(X.value),1)]),e("div",Ze,[t[34]||(t[34]=e("p",{class:"text-muted-foreground"},"Coût estimé",-1)),e("p",et,l(U.value)+" XAF",1)])])])])]),M.value?(n(),a("div",tt,[e("div",st,[d(u(I),{class:"w-5 h-5"}),e("p",ot,l(M.value),1)])])):v("",!0),$.value?(n(),a("div",lt,[e("div",rt,[d(u(L),{class:"w-5 h-5"}),e("p",nt,l($.value),1)])])):v("",!0),e("div",it,[e("button",{onClick:H,disabled:!D.value||k.value,class:"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-success text-success-foreground hover:bg-success/90 h-10 px-6 py-2"},[k.value?(n(),a("div",ut)):(n(),B(u(z),{key:0,class:"w-5 h-5"})),e("span",null,l(k.value?"Envoi en cours...":"Envoyer maintenant"),1)],8,at),e("button",{onClick:T,disabled:k.value,class:"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2"},[d(u(ve),{class:"w-4 h-4"}),t[36]||(t[36]=e("span",null,"Réinitialiser",-1))],8,dt)])])])])]),_:1}))}});export{_t as default};
